<style>
/* Import cute fonts to match main project */
@import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,600;0,700;0,800;1,400&family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,400&display=swap');

/* Cute font applications to match main project */
.cute-title {
  font-family: 'Comic Neue', cursive;
  font-weight: 700;
}

.cute-text {
  font-family: 'Nunito', sans-serif;
  font-weight: 400;
}

.cute-heading {
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
}

.cute-subheading {
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
}

/* City cards - clean sections */
.city-card {
  background: linear-gradient(135deg, 
    rgba(55, 65, 81, 0.95) 0%, 
    rgba(75, 85, 99, 0.95) 50%, 
    rgba(55, 65, 81, 0.95) 100%);
  border: 2px solid rgba(139, 92, 246, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  padding: 24px;
  margin: 16px 0;
  overflow: visible;
  transition: all 0.3s ease;
}

/* LOCKED CITIES */
.city-card.locked {
  background: linear-gradient(135deg, 
    rgba(55, 65, 81, 0.4) 0%, 
    rgba(75, 85, 99, 0.4) 50%, 
    rgba(55, 65, 81, 0.4) 100%);
  border: 2px solid rgba(107, 114, 128, 0.3);
  opacity: 0.6;
  filter: grayscale(80%);
}

.city-card.locked h3 {
  color: #9ca3af !important;
}

.city-card.locked p, .city-card.locked div {
  color: #6b7280 !important;
}

.city-card.locked::after {
  content: '🔒 Complete previous city to unlock';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(31, 41, 55, 0.95);
  color: #9ca3af;
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  font-size: 14px;
  border: 1px solid rgba(107, 114, 128, 0.5);
  z-index: 10;
}

.city-card.unlocked {
  animation: unlockPulse 1s ease-out;
}

@keyframes unlockPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
  50% { transform: scale(1.02); box-shadow: 0 0 0 20px rgba(139, 92, 246, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
}

/* Progress indicators on city cards */
.city-progress {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(139, 92, 246, 0.2);
  border: 1px solid rgba(139, 92, 246, 0.5);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 600;
  color: #c084fc;
}

.city-progress.completed {
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.5);
  color: #10b981;
}

/* Travel route connector */
.travel-route {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 32px 0;
  position: relative;
}

.route-line {
  width: 4px;
  height: 60px;
  background: linear-gradient(to bottom, 
    rgba(139, 92, 246, 0.8) 0%,
    rgba(59, 130, 246, 0.8) 50%,
    rgba(139, 92, 246, 0.8) 100%);
  border-radius: 2px;
  position: relative;
  animation: pulse 2s infinite;
}

.route-line.locked {
  background: linear-gradient(to bottom, 
    rgba(107, 114, 128, 0.4) 0%,
    rgba(107, 114, 128, 0.4) 50%,
    rgba(107, 114, 128, 0.4) 100%);
  animation: none;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* ENHANCED: Clickable route button */
.route-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 24px;
  background: rgba(31, 41, 55, 0.95);
  padding: 12px;
  border-radius: 50%;
  border: 2px solid rgba(139, 92, 246, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.route-button:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: rgba(139, 92, 246, 0.8);
  transform: translate(-50%, -50%) scale(1.1);
  box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
}

.route-button.active {
  background: rgba(139, 92, 246, 0.3);
  border-color: rgba(139, 92, 246, 1);
}

.route-button.locked {
  background: rgba(107, 114, 128, 0.3);
  border-color: rgba(107, 114, 128, 0.5);
  cursor: not-allowed;
  opacity: 0.5;
}

.route-button.locked:hover {
  transform: translate(-50%, -50%);
  box-shadow: none;
}

/* ENHANCED: Pitstops container with dropdown functionality */
.pitstops-section {
  background: linear-gradient(135deg, 
    rgba(31, 41, 55, 0.95) 0%, 
    rgba(55, 65, 81, 0.95) 100%);
  border: 2px solid rgba(59, 130, 246, 0.4);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px;
  margin: 16px 0;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
  display: none; /* HIDDEN by default */
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.4s ease;
}

.pitstops-section.show {
  display: block;
  animation: slideDown 0.4s ease-out forwards;
}

@keyframes slideDown {
  0% {
    opacity: 0;
    transform: translateY(-20px) scaleY(0.8);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scaleY(1);
  }
}

.pitstops-title {
  text-align: center;
  color: #60a5fa;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.pitstops-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 16px;
}

/* ENHANCED: Pitstop items with activity sections */
.pitstop-item {
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
  cursor: default;
  position: relative;
}

.pitstop-item:hover {
  background: rgba(59, 130, 246, 0.25);
  border-color: rgba(59, 130, 246, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

.pitstop-item.completed::after {
  content: '✅';
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 18px;
}

.pitstop-name {
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
  color: #93c5fd;
  font-size: 16px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pitstop-description {
  font-family: 'Nunito', sans-serif;
  font-weight: 400;
  color: #d1d5db;
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 16px;
}

/* NEW: Activity sections */
.pitstop-activity {
  background: rgba(139, 92, 246, 0.1);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
}

.activity-title {
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  color: #c084fc;
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.activity-content {
  display: none;
  margin-top: 12px;
}

.activity-content.show {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.activity-prompt {
  background: rgba(31, 41, 55, 0.7);
  border-left: 4px solid #8b5cf6;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 0 8px 8px 0;
  font-size: 13px;
  color: #e5e7eb;
  line-height: 1.4;
}

.activity-input {
  width: 100%;
  background: rgba(31, 41, 55, 0.8);
  border: 1px solid rgba(139, 92, 246, 0.4);
  border-radius: 6px;
  padding: 10px 12px;
  color: #e5e7eb;
  font-size: 13px;
  font-family: 'Nunito', sans-serif;
  margin: 8px 0;
  transition: border-color 0.3s ease;
}

.activity-input:focus {
  outline: none;
  border-color: rgba(139, 92, 246, 0.8);
  box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
}

.activity-button {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 8px 4px 4px 0;
}

.activity-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.activity-toggle {
  background: transparent;
  border: 1px solid rgba(139, 92, 246, 0.4);
  color: #c084fc;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: auto;
}

.activity-toggle:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: rgba(139, 92, 246, 0.6);
}

/* Data tag styling to match theme */
.data-tag {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: 2px solid rgba(139, 92, 246, 0.4);
  color: white;
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
  transition: all 0.3s ease;
}

.data-tag:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.6);
  border: 2px solid rgba(139, 92, 246, 0.8);
}

/* Prerequisite button styling */
.prereq-button {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: 2px solid rgba(139, 92, 246, 0.4);
  padding: 12px 24px;
  border-radius: 25px;
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
  position: relative;
  overflow: hidden;
  font-family: 'Nunito', sans-serif;
}

.prereq-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.6);
  border: 2px solid rgba(139, 92, 246, 0.8);
}

.prereq-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.prereq-button:hover::before {
  left: 100%;
}

/* UNLOCK NOTIFICATION */
.unlock-notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 16px 32px;
  border-radius: 25px;
  font-weight: 600;
  font-size: 16px;
  z-index: 1000;
  box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
  animation: slideInDown 0.5s ease-out;
}

@keyframes slideInDown {
  from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

@media (max-width: 768px) {
  .city-card {
    padding: 16px;
    margin: 12px 0;
  }
  
  .pitstops-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .pitstop-item {
    padding: 16px;
  }
  
  .route-line {
    height: 40px;
  }
  
  .route-button {
    font-size: 18px;
    padding: 8px;
  }
  
  .city-card.locked::after {
    font-size: 12px;
    padding: 10px 16px;
  }
}
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900">
  <div class="container mx-auto px-8 py-16">

    {% if page.lxdData.Prequisites %}
    <div class="mb-16 text-center">
      <h3 class="text-2xl font-bold text-white mb-8 cute-heading">🎯 Prerequisites</h3>
      <ul class="flex flex-wrap gap-8 justify-center">
        {% for prereq in page.lxdData.Prequisites %}
          <li>
            <a href="{{ site.baseurl}}{{ prereq.link }}" class="prereq-button cute-text">
              {{ prereq.title }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="relative z-10">
      
      <!-- Node Title & Description -->
      <div class="text-center mb-20">
        <div class="inline-block relative mb-10">
          <h2 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 cute-title">
            {{ page.lxdData.Title }}
          </h2>
          <div class="absolute -inset-2 bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 opacity-20 blur-xl rounded-lg"></div>
        </div>
        {% if page.lxdData.Description %}
        <p class="text-xl text-gray-300 max-w-4xl mx-auto leading-relaxed cute-text px-6">
          {{ page.lxdData.Description }}
        </p>
        {% endif %}
      </div>

      <!-- Progress Overview -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center gap-4 bg-rgba(31, 41, 55, 0.8) rounded-2xl px-6 py-3 border border-purple-500/30">
          <span class="text-white cute-text">Journey Progress:</span>
          <span class="text-green-400 font-bold" id="overall-progress">City 1/4</span>
          <span class="text-purple-400" id="total-activities">0 activities completed</span>
        </div>
      </div>

      <!-- Travel Route with Cities and Pitstops -->
      <div class="max-w-5xl mx-auto">
        {% if page.lxdData.Cities %}
          {% for city in page.lxdData.Cities %}
            
            <!-- City Card -->
            <div class="city-card rounded-2xl shadow-lg relative" id="city-{{ forloop.index0 }}" data-city-index="{{ forloop.index0 }}">
              <!-- Progress indicator -->
              <div class="city-progress" id="progress-{{ forloop.index0 }}">
                0/{{ city.Pitstops.size | default: 3 }}
              </div>
              
              <!-- City Title -->
              <div class="w-full mb-4">
                <h3 class="text-3xl xl:text-4xl font-bold text-white cute-heading">
                  🏙️ {{ city.Name }}
                </h3>
              </div>

              <!-- City Description -->
              <div class="w-full">
                {% if city.Description %}
                <p class="text-gray-300 text-lg leading-relaxed cute-text mb-4">{{ city.Description }}</p>
                {% endif %}
                {% if city.Challenge %}
                <div class="text-sm text-purple-400 cute-text mb-2">
                  🎯 <strong>Challenge:</strong> {{ city.Challenge }}
                </div>
                {% endif %}
                {% if city.Analogy %}
                <div class="text-sm text-blue-400 cute-text">
                  💡 <strong>Analogy:</strong> {{ city.Analogy }}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Travel Route & Pitstops (only if not the last city) -->
            {% unless forloop.last %}
              <div class="travel-route">
                <div class="route-line" id="route-{{ forloop.index0 }}">
                  <!-- ENHANCED: Clickable route button -->
                  <button class="route-button" id="route-btn-{{ forloop.index0 }}" data-route="{{ forloop.index0 }}" title="Click to explore pitstops">
                    🛣️
                  </button>
                </div>
              </div>

              <!-- ENHANCED: Hidden pitstops section with activities -->
              {% if city.Pitstops and city.Pitstops.size > 0 %}
              <div class="pitstops-section" id="pitstops-{{ forloop.index0 }}">
                <div class="pitstops-title cute-subheading">
                  🗺️ Travel Pitstops: {{ city.Name }} → 
                  {% assign next_index = forloop.index %}
                  {% for next_city in page.lxdData.Cities %}
                    {% if forloop.index == next_index %}
                      {{ next_city.Name }}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                </div>
                
                <div class="pitstops-grid">
                  {% for pitstop in city.Pitstops %}
                    <div class="pitstop-item" id="pitstop-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}">
                      <div class="pitstop-name">
                        📍 {{ pitstop.Name }}
                      </div>
                      <div class="pitstop-description">
                        {{ pitstop.Description }}
                      </div>
                      
                      <!-- DYNAMIC ACTIVITY SECTION -->
                      <div class="pitstop-activity">
                        <div class="activity-title">
                          🎯 Code Challenge
                          <button class="activity-toggle" onclick="toggleActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                            Try It
                          </button>
                        </div>
                        
                        <div class="activity-content" id="activity-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}">
                          <div class="activity-prompt" id="prompt-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                               data-city="{{ forloop.parentloop.index0 }}"
                               data-pitstop="{{ forloop.index0 }}"
                               data-original-activity="{{ pitstop.Activity | escape }}"
                               data-hints="{{ pitstop.Hints | join: '||' | escape }}">
                            <!-- Dynamic prompt will be generated by JavaScript -->
                          </div>
                          
                          <textarea 
                            class="activity-input" 
                            id="input-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                            placeholder="Write your code solution here..."
                            rows="6">
                          </textarea>
                          
                          <div>
                            <button class="activity-button" onclick="checkActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Submit
                            </button>
                            <button class="activity-button" onclick="hintActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Hint
                            </button>
                            <button class="activity-button" onclick="resetActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Reset
                            </button>
                          </div>
                          
                          <div class="activity-prompt" id="feedback-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}" style="display: none;">
                            <!-- Dynamic feedback will appear here -->
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            {% endunless %}

          {% endfor %}
        {% else %}
          <div class="text-center text-red-400">
            <p>No cities data found. Check your markdown file structure.</p>
          </div>
        {% endif %}
      </div>

      <!-- Back to Hub Button -->
      <div class="text-center mt-20">
        <a href="{{ site.baseurl }}/travel_hub" class="prereq-button cute-text inline-block">
          🏠 Back to Travel Hub
        </a>
      </div>

    </div>
  </div>
</div>

<script type="text/javascript">
// CITY UNLOCKING SYSTEM
let gameProgress = {
  unlockedCities: [0], // San Diego starts unlocked
  completedActivities: {},
  totalActivitiesCompleted: 0
};

// Load progress from localStorage
function loadGameProgress() {
  const saved = localStorage.getItem('mchopiee_city_progress');
  if (saved) {
    try {
      gameProgress = JSON.parse(saved);
    } catch (e) {
      console.error('Error loading game progress:', e);
    }
  }
}

// Save progress to localStorage
function saveGameProgress() {
  try {
    localStorage.setItem('mchopiee_city_progress', JSON.stringify(gameProgress));
  } catch (e) {
    console.error('Error saving game progress:', e);
  }
}

// Initialize city locking on page load
function initializeCityLocking() {
  loadGameProgress();
  
  // Get all city cards
  const cityCards = document.querySelectorAll('.city-card');
  const routeButtons = document.querySelectorAll('.route-button');
  const routeLines = document.querySelectorAll('.route-line');
  
  // Lock all cities except unlocked ones
  cityCards.forEach((card, index) => {
    if (!gameProgress.unlockedCities.includes(index)) {
      lockCity(index);
    } else {
      unlockCity(index);
    }
  });
  
  // Lock route buttons for locked cities
  routeButtons.forEach((button, index) => {
    if (!gameProgress.unlockedCities.includes(index + 1)) {
      lockRoute(index);
    }
  });
  
  updateProgressDisplay();
  loadAndDisplayProgress();
}

function lockCity(cityIndex) {
  const cityCard = document.getElementById(`city-${cityIndex}`);
  if (cityCard) {
    cityCard.classList.add('locked');
    cityCard.style.position = 'relative';
  }
}

function unlockCity(cityIndex) {
  const cityCard = document.getElementById(`city-${cityIndex}`);
  if (cityCard) {
    cityCard.classList.remove('locked');
    cityCard.classList.add('unlocked');
    
    // Show unlock notification if this is a new unlock
    if (cityIndex > 0) {
      showUnlockNotification(cityIndex);
    }
  }
}

function lockRoute(routeIndex) {
  const routeButton = document.getElementById(`route-btn-${routeIndex}`);
  const routeLine = document.getElementById(`route-${routeIndex}`);
  
  if (routeButton) {
    routeButton.classList.add('locked');
    routeButton.title = 'Complete current city to unlock';
  }
  
  if (routeLine) {
    routeLine.classList.add('locked');
  }
}

function unlockRoute(routeIndex) {
  const routeButton = document.getElementById(`route-btn-${routeIndex}`);
  const routeLine = document.getElementById(`route-${routeIndex}`);
  
  if (routeButton) {
    routeButton.classList.remove('locked');
    routeButton.title = 'Click to explore pitstops';
  }
  
  if (routeLine) {
    routeLine.classList.remove('locked');
  }
}

function showUnlockNotification(cityIndex) {
  const cityNames = ['San Diego', 'Los Angeles', 'San Francisco', 'Seattle'];
  const cityName = cityNames[cityIndex] || `City ${cityIndex + 1}`;
  
  const notification = document.createElement('div');
  notification.className = 'unlock-notification';
  notification.innerHTML = `🎉 ${cityName} Unlocked! Continue your journey!`;
  
  document.body.appendChild(notification);
  
  // Remove notification after 4 seconds
  setTimeout(() => {
    if (document.body.contains(notification)) {
      notification.style.animation = 'slideInDown 0.5s ease-out reverse';
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 500);
    }
  }, 4000);
}

function checkCityCompletion(cityIndex) {
  // Count completed activities for this city
  const cityActivities = Object.keys(gameProgress.completedActivities).filter(key => 
    key.startsWith(`${cityIndex}-`)
  );
  
  // Get total activities for this city (count pitstops)
  const pitstops = document.querySelectorAll(`[id^="pitstop-${cityIndex}-"]`);
  const totalActivities = pitstops.length;
  
  // Update progress display
  const progressElement = document.getElementById(`progress-${cityIndex}`);
  if (progressElement) {
    progressElement.textContent = `${cityActivities.length}/${totalActivities}`;
    
    if (cityActivities.length === totalActivities && totalActivities > 0) {
      progressElement.classList.add('completed');
      progressElement.textContent = '✅ Complete';
    }
  }
  
  // Check if city should be completed (all activities done)
  if (cityActivities.length >= totalActivities && totalActivities > 0) {
    completeCity(cityIndex);
  }
}

function completeCity(cityIndex) {
  // Mark next city as unlocked
  const nextCityIndex = cityIndex + 1;
  
  if (nextCityIndex < 4 && !gameProgress.unlockedCities.includes(nextCityIndex)) {
    gameProgress.unlockedCities.push(nextCityIndex);
    saveGameProgress();
    
    // Unlock the next city
    unlockCity(nextCityIndex);
    unlockRoute(cityIndex); // Unlock the route TO the next city
    
    updateProgressDisplay();
  }
}

function updateProgressDisplay() {
  // Update overall progress
  const overallProgress = document.getElementById('overall-progress');
  const totalActivitiesElement = document.getElementById('total-activities');
  
  if (overallProgress) {
    const completedCities = Math.max(0, gameProgress.unlockedCities.length - 1);
    overallProgress.textContent = `City ${gameProgress.unlockedCities.length}/4`;
  }
  
  if (totalActivitiesElement) {
    totalActivitiesElement.textContent = `${gameProgress.totalActivitiesCompleted} activities completed`;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('=== ROUTE DROPDOWN SETUP ===');
  
  // Initialize city locking system FIRST
  initializeCityLocking();
  
  var routeButtons = document.querySelectorAll('.route-button');
  console.log('Found ' + routeButtons.length + ' route buttons');
  
  for (var i = 0; i < routeButtons.length; i++) {
    routeButtons[i].addEventListener('click', function(e) {
      // Check if route is locked
      if (this.classList.contains('locked')) {
        alert('🔒 Complete the current city first to unlock this route!');
        return;
      }
      
      console.log('Route button clicked!');
      
      var routeIndex = this.getAttribute('data-route');
      var pitstopsSection = document.getElementById('pitstops-' + routeIndex);
      
      console.log('Toggling pitstops-' + routeIndex);
      
      if (!pitstopsSection) {
        console.log('Pitstops section not found!');
        return;
      }
      
      var isVisible = pitstopsSection.classList.contains('show');
      console.log('Currently visible:', isVisible);
      
      // Close all other pitstops sections and reset buttons
      var allPitstops = document.querySelectorAll('.pitstops-section');
      var allButtons = document.querySelectorAll('.route-button');
      
      for (var j = 0; j < allPitstops.length; j++) {
        allPitstops[j].classList.remove('show');
      }
      
      for (var k = 0; k < allButtons.length; k++) {
        allButtons[k].classList.remove('active');
      }
      
      // Toggle current pitstops section
      if (!isVisible) {
        pitstopsSection.classList.add('show');
        this.classList.add('active');
        console.log('OPENED pitstops ' + routeIndex);
        
        // Smooth scroll to the pitstops section
        setTimeout(function() {
          pitstopsSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }, 200);
      } else {
        console.log('CLOSED pitstops ' + routeIndex);
      }
    });
  }
  
  // Initialize city-specific activities
  initializeCityActivities();
});

function initializeCityActivities() {
  console.log('Initializing city-specific activities...');
  
  var activityPrompts = document.querySelectorAll('[data-city]');
  
  for (var i = 0; i < activityPrompts.length; i++) {
    var prompt = activityPrompts[i];
    var cityIndex = parseInt(prompt.getAttribute('data-city'));
    var pitstopIndex = parseInt(prompt.getAttribute('data-pitstop'));
    var originalActivity = prompt.getAttribute('data-original-activity');
    
    var cityActivity = generateCityActivity(cityIndex, pitstopIndex, originalActivity);
    prompt.textContent = cityActivity;
    console.log('City ' + cityIndex + ' Pitstop ' + pitstopIndex + ':', cityActivity);
  }
}

// UPDATED: City-specific activity generation based on your specifications
function generateCityActivity(cityIndex, pitstopIndex, originalActivity) {
  const cityActivities = {
    // 🏖️ San Diego - "Build the Baja Bowl" (CREATE)
    0: [
      // Form validation & dish creation
      'Create a Dish Form class that validates: dishName (required, min 3 chars), category (bowl/taco/salad), ingredients array (min 1 item). Include methods validateRequired() and getFormData().',
      
      // Ingredient management
      'Build an IngredientManager class with methods: addIngredient(name, qty, unit), removeIngredient(index), validateIngredients(). Handle edge cases like duplicate ingredients and invalid quantities.',
      
      // Database simulation with API calls
      'Write an async function createDish(dishData) that simulates POST /api/dishes. Include proper error handling, 201 response simulation, and toast notification: "Baja Bowl added — +50 XP".'
    ],
    
    // 🌴 Los Angeles - "Food Truck Tasting" (READ & FILTER)
    1: [
      // List & filter implementation
      'Create a DishFilter class that implements: filterByCity(dishes, city), filterByCalories(dishes, minCal), filterByIngredient(dishes, ingredient). Use array methods and pagination logic.',
      
      // Search functionality with performance
      'Build a search function that queries: /api/dishes?city=la&page=1&per=10&min_cal=300&ingredient=avocado. Include loading states, error handling, and simulated indexing performance metrics.',
      
      // Dev Console SQL display
      'Write a QueryBuilder class that generates safe SQL examples: "SELECT * FROM dishes WHERE city = ? AND calories >= ? AND ingredients LIKE ?". Display in a Dev Console with syntax highlighting.'
    ],
    
    // 🌁 San Francisco - "Gourmet Pop-Up" (UPDATE & TRANSACTIONS)
    2: [
      // Edit dish with transactions
      'Create an EditDish class with methods: updateIngredients(dishId, ingredients), renameDish(dishId, newName), saveChanges(). Wrap all changes in a simulated transaction with rollback capability.',
      
      // Conflict resolution system
      'Build a ConflictResolver that detects version mismatches: checkVersion(dishId, currentVersion), handleConflict(conflicts), showResolutionModal(). Include optimistic locking simulation.',
      
      // Preview changes modal
      'Implement a ChangePreview component that shows before/after diff: generateDiff(original, updated), displayChanges(), confirmChanges(). Include PUT /api/dishes/:id simulation with atomic updates.'
    ],
    
    // 🌲 Seattle - "Sustainable Cleanup with Clam Chowder" (DELETE & ADVANCED)
    3: [
      // Soft delete implementation
      'Create a DeletionManager class with methods: softDelete(dishId), hardDelete(dishId), restoreArchived(dishId). Add deleted_at timestamps and implement archival list filtering.',
      
      // Analytics dashboard
      'Build an AnalyticsDashboard that aggregates: topIngredients(), caloriesByCity(), dishesByCategory(), archivedVsActive(). Use reduce(), groupBy(), and data visualization helpers.',
      
      // Cascading delete system
      'Implement cascading deletion: deleteDishAndRelated(dishId) that removes dish_ingredients, reviews, and photos. Include confirmation dialogs and undo functionality within 30 seconds.'
    ]
  };
  
  const activities = cityActivities[cityIndex];
  if (!activities || pitstopIndex >= activities.length) {
    return 'Write code to practice database operations and web development concepts.';
  }
  
  return activities[pitstopIndex];
}

function toggleActivity(activityId) {
  var content = document.getElementById('activity-' + activityId);
  var toggle = event.target;
  
  if (!content) {
    console.error('Activity content not found for:', activityId);
    return;
  }
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    toggle.textContent = 'Try It';
  } else {
    content.classList.add('show');
    toggle.textContent = 'Hide';
  }
}

function checkActivity(activityId) {
  var input = document.getElementById('input-' + activityId);
  var feedback = document.getElementById('feedback-' + activityId);
  var prompt = document.getElementById('prompt-' + activityId);
  
  if (!input || !feedback || !prompt) {
    console.error('Required elements not found for:', activityId);
    return;
  }
  
  var userInput = input.value.trim();
  var cityIndex = parseInt(prompt.getAttribute('data-city'));
  
  if (userInput.length < 20) {
    showFeedback(feedback, "Please provide a more detailed solution! Your code should be at least 20 characters.", "warning");
    return;
  }
  
  // City-specific validation
  var validation = validateCityActivity(cityIndex, userInput);
  
  if (validation.isValid) {
    if (validation.isExcellent) {
      showFeedback(feedback, `🎉 Excellent work! ${validation.message} +50 XP earned!`, "success");
      saveActivityProgress(activityId, true);
    } else {
      showFeedback(feedback, `✅ Good job! ${validation.message} +25 XP earned!`, "success");
      saveActivityProgress(activityId, true);
    }
  } else {
    showFeedback(feedback, `💡 ${validation.message} Keep trying!`, "info");
  }
}

// UPDATED: City-specific validation based on your requirements
function validateCityActivity(cityIndex, userCode) {
  const code = userCode.toLowerCase();
  
  const cityValidators = {
    // San Diego - CREATE operations
    0: () => {
      const hasClass = code.includes('class') || code.includes('function');
      const hasValidation = code.includes('validate') || code.includes('required');
      const hasFormData = code.includes('form') || code.includes('input') || code.includes('dish');
      const hasErrorHandling = code.includes('error') || code.includes('try') || code.includes('catch');
      
      if (hasClass && hasValidation && hasFormData && hasErrorHandling) {
        return { isValid: true, isExcellent: true, message: "Perfect form validation with error handling!" };
      } else if (hasClass && hasValidation) {
        return { isValid: true, isExcellent: false, message: "Good validation logic! Consider adding error handling." };
      } else {
        return { isValid: false, message: "Include class/function definition and validation logic." };
      }
    },
    
    // Los Angeles - READ & FILTER operations
    1: () => {
      const hasFilter = code.includes('filter') || code.includes('where');
      const hasPagination = code.includes('page') || code.includes('limit') || code.includes('slice');
      const hasSearch = code.includes('search') || code.includes('includes') || code.includes('indexof');
      const hasPerformance = code.includes('index') || code.includes('performance') || code.includes('time');
      
      if (hasFilter && hasPagination && hasSearch && hasPerformance) {
        return { isValid: true, isExcellent: true, message: "Excellent filtering with performance optimization!" };
      } else if (hasFilter && hasSearch) {
        return { isValid: true, isExcellent: false, message: "Good filtering! Add pagination and performance metrics." };
      } else {
        return { isValid: false, message: "Include filtering and search functionality." };
      }
    },
    
    // San Francisco - UPDATE & TRANSACTIONS
    2: () => {
      const hasUpdate = code.includes('update') || code.includes('edit') || code.includes('modify');
      const hasTransaction = code.includes('transaction') || code.includes('rollback') || code.includes('commit');
      const hasConflict = code.includes('conflict') || code.includes('version') || code.includes('lock');
      const hasPreview = code.includes('preview') || code.includes('diff') || code.includes('before');
      
      if (hasUpdate && hasTransaction && hasConflict && hasPreview) {
        return { isValid: true, isExcellent: true, message: "Perfect transaction handling with conflict resolution!" };
      } else if (hasUpdate && hasTransaction) {
        return { isValid: true, isExcellent: false, message: "Good transaction logic! Add conflict resolution." };
      } else {
        return { isValid: false, message: "Include update operations and transaction handling." };
      }
    },
    
    // Seattle - DELETE & ANALYTICS
    3: () => {
      const hasDelete = code.includes('delete') || code.includes('remove') || code.includes('archive');
      const hasSoftDelete = code.includes('soft') || code.includes('deleted_at') || code.includes('archived');
      const hasAnalytics = code.includes('analytics') || code.includes('aggregate') || code.includes('group');
      const hasCascade = code.includes('cascade') || code.includes('related') || code.includes('dependencies');
      
      if (hasDelete && hasSoftDelete && hasAnalytics && hasCascade) {
        return { isValid: true, isExcellent: true, message: "Excellent deletion system with analytics!" };
      } else if (hasDelete && hasSoftDelete) {
        return { isValid: true, isExcellent: false, message: "Good deletion logic! Add analytics and cascading." };
      } else {
        return { isValid: false, message: "Include deletion operations and soft delete functionality." };
      }
    }
  };
  
  const validator = cityValidators[cityIndex];
  if (!validator) {
    return { isValid: false, message: "Unknown city validation." };
  }
  
  return validator();
}

// ENHANCED: Progress saving functions with city unlocking
function saveActivityProgress(activityId, isCompleted) {
  if (isCompleted) {
    // Mark activity as completed
    gameProgress.completedActivities[activityId] = true;
    gameProgress.totalActivitiesCompleted++;
    
    // Get city index from activity ID
    const cityIndex = parseInt(activityId.split('-')[0]);
    
    // Mark pitstop as completed visually
    const pitstopElement = document.getElementById(`pitstop-${activityId}`);
    if (pitstopElement) {
      pitstopElement.classList.add('completed');
    }
    
    // Check if city should be completed
    checkCityCompletion(cityIndex);
    
    // Save progress
    saveGameProgress();
    
    // Show completion feedback
    showActivityCompletionFeedback(activityId);
  }
}

function showActivityCompletionFeedback(activityId) {
  // Create a toast notification
  var toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
  toast.innerHTML = '<div class="flex items-center gap-2"><span class="text-lg">🎉</span><div><div class="font-bold">Activity Completed!</div><div class="text-sm">Progress saved!</div></div></div>';
  
  document.body.appendChild(toast);
  
  // Animate in
  setTimeout(function() {
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  // Remove after 3 seconds
  setTimeout(function() {
    toast.style.transform = 'translateX(100%)';
    setTimeout(function() {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Load and display existing progress when page loads
function loadAndDisplayProgress() {
  // Mark completed activities with visual indicators
  Object.keys(gameProgress.completedActivities).forEach(function(activityId) {
    var activityElement = document.getElementById('activity-' + activityId);
    var inputElement = document.getElementById('input-' + activityId);
    var feedbackElement = document.getElementById('feedback-' + activityId);
    var pitstopElement = document.getElementById('pitstop-' + activityId);
    
    if (activityElement) {
      // Add completed styling
      activityElement.style.border = '2px solid #10b981';
      activityElement.style.background = 'rgba(16, 185, 129, 0.1)';
      
      if (feedbackElement) {
        showFeedback(feedbackElement, "✅ Previously completed! Great work!", "success");
      }
      
      if (inputElement) {
        inputElement.style.background = 'rgba(16, 185, 129, 0.1)';
      }
      
      if (pitstopElement) {
        pitstopElement.classList.add('completed');
      }
    }
  });
  
  // Update city progress for all cities
  for (let i = 0; i < 4; i++) {
    checkCityCompletion(i);
  }
}

function showFeedback(feedbackElement, message, type) {
  if (!feedbackElement) {
    console.error('Feedback element not found');
    return;
  }
  
  // Clear any existing classes
  feedbackElement.className = 'activity-prompt';
  
  // Add type-specific styling
  if (type === 'success') {
    feedbackElement.style.borderLeftColor = '#10b981';
    feedbackElement.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
    feedbackElement.style.color = '#34d399';
  } else if (type === 'warning') {
    feedbackElement.style.borderLeftColor = '#f59e0b';
    feedbackElement.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
    feedbackElement.style.color = '#fbbf24';
  } else if (type === 'info') {
    feedbackElement.style.borderLeftColor = '#3b82f6';
    feedbackElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
    feedbackElement.style.color = '#60a5fa';
  } else {
    feedbackElement.style.borderLeftColor = '#8b5cf6';
    feedbackElement.style.backgroundColor = 'rgba(139, 92, 246, 0.1)';
    feedbackElement.style.color = '#c084fc';
  }
  
  feedbackElement.textContent = message;
  feedbackElement.style.display = 'block';
  
  // Animate in
  feedbackElement.style.opacity = '0';
  feedbackElement.style.transform = 'translateY(-10px)';
  
  setTimeout(function() {
    feedbackElement.style.transition = 'all 0.3s ease';
    feedbackElement.style.opacity = '1';
    feedbackElement.style.transform = 'translateY(0)';
  }, 50);
}

function hintActivity(activityId) {
  var promptElement = document.getElementById('prompt-' + activityId);
  var feedbackElement = document.getElementById('feedback-' + activityId);
  
  if (!promptElement || !feedbackElement) {
    console.error('Prompt or feedback element not found for:', activityId);
    return;
  }
  
  var cityIndex = parseInt(promptElement.getAttribute('data-city'));
  var hints = getCityHints(cityIndex);
  var randomHint = hints[Math.floor(Math.random() * hints.length)];
  
  showFeedback(feedbackElement, "💡 Hint: " + randomHint, "info");
}

function getCityHints(cityIndex) {
  const cityHints = {
    0: [ // San Diego
      "Start with a class or function that handles form data",
      "Include validation for required fields like dish name",
      "Add error handling with try/catch blocks",
      "Consider using methods like validateRequired() and getFormData()"
    ],
    1: [ // Los Angeles
      "Use array methods like filter() and slice() for pagination",
      "Include search functionality with includes() or indexOf()",
      "Add performance metrics with console.time()",
      "Think about indexing for faster queries"
    ],
    2: [ // San Francisco
      "Wrap multiple operations in a transaction",
      "Include version checking for conflict resolution",
      "Add a preview system that shows changes before saving",
      "Consider rollback functionality for failed operations"
    ],
    3: [ // Seattle
      "Implement both soft delete (archived_at) and hard delete",
      "Use reduce() and groupBy() for analytics",
      "Add cascading deletion for related records",
      "Include confirmation dialogs for destructive operations"
    ]
  };
  
  return cityHints[cityIndex] || ["Try including relevant keywords and concepts for this challenge."];
}

function resetActivity(activityId) {
  var inputElement = document.getElementById('input-' + activityId);
  var feedbackElement = document.getElementById('feedback-' + activityId);
  var activityElement = document.getElementById('activity-' + activityId);
  
  if (inputElement) {
    inputElement.value = '';
    inputElement.style.background = 'rgba(31, 41, 55, 0.8)';
  }
  
  if (feedbackElement) {
    feedbackElement.style.display = 'none';
    feedbackElement.textContent = '';
  }
  
  if (activityElement) {
    activityElement.style.border = '1px solid rgba(139, 92, 246, 0.3)';
    activityElement.style.background = 'rgba(139, 92, 246, 0.1)';
  }
  
  showFeedback(feedbackElement, "🔄 Activity reset! Try again with a fresh start.", "info");
}
</script>