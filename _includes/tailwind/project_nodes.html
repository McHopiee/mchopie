<style>
/* Import cute fonts to match main project */
@import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,600;0,700;0,800;1,400&family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,400&display=swap');

/* Cute font applications to match main project */
.cute-title {
  font-family: 'Comic Neue', cursive;
  font-weight: 700;
}

.cute-text {
  font-family: 'Nunito', sans-serif;
  font-weight: 400;
}

.cute-heading {
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
}

.cute-subheading {
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
}

/* City cards - clean sections */
.city-card {
  background: linear-gradient(135deg, 
    rgba(55, 65, 81, 0.95) 0%, 
    rgba(75, 85, 99, 0.95) 50%, 
    rgba(55, 65, 81, 0.95) 100%);
  border: 2px solid rgba(139, 92, 246, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  padding: 24px;
  margin: 16px 0;
  overflow: visible;
  transition: all 0.3s ease;
}

/* Travel route connector */
.travel-route {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 32px 0;
  position: relative;
}

.route-line {
  width: 4px;
  height: 60px;
  background: linear-gradient(to bottom, 
    rgba(139, 92, 246, 0.8) 0%,
    rgba(59, 130, 246, 0.8) 50%,
    rgba(139, 92, 246, 0.8) 100%);
  border-radius: 2px;
  position: relative;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* ENHANCED: Clickable route button */
.route-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 24px;
  background: rgba(31, 41, 55, 0.95);
  padding: 12px;
  border-radius: 50%;
  border: 2px solid rgba(139, 92, 246, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}

.route-button:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: rgba(139, 92, 246, 0.8);
  transform: translate(-50%, -50%) scale(1.1);
  box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
}

.route-button.active {
  background: rgba(139, 92, 246, 0.3);
  border-color: rgba(139, 92, 246, 1);
}

/* ENHANCED: Pitstops container with dropdown functionality */
.pitstops-section {
  background: linear-gradient(135deg, 
    rgba(31, 41, 55, 0.95) 0%, 
    rgba(55, 65, 81, 0.95) 100%);
  border: 2px solid rgba(59, 130, 246, 0.4);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px;
  margin: 16px 0;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
  display: none; /* HIDDEN by default */
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.4s ease;
}

.pitstops-section.show {
  display: block;
  animation: slideDown 0.4s ease-out forwards;
}

@keyframes slideDown {
  0% {
    opacity: 0;
    transform: translateY(-20px) scaleY(0.8);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scaleY(1);
  }
}

.pitstops-title {
  text-align: center;
  color: #60a5fa;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.pitstops-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 16px;
}

/* ENHANCED: Pitstop items with activity sections */
.pitstop-item {
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
  cursor: default;
}

.pitstop-item:hover {
  background: rgba(59, 130, 246, 0.25);
  border-color: rgba(59, 130, 246, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
}

.pitstop-name {
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
  color: #93c5fd;
  font-size: 16px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pitstop-description {
  font-family: 'Nunito', sans-serif;
  font-weight: 400;
  color: #d1d5db;
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 16px;
}

/* NEW: Activity sections */
.pitstop-activity {
  background: rgba(139, 92, 246, 0.1);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
}

.activity-title {
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  color: #c084fc;
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.activity-content {
  display: none;
  margin-top: 12px;
}

.activity-content.show {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.activity-prompt {
  background: rgba(31, 41, 55, 0.7);
  border-left: 4px solid #8b5cf6;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 0 8px 8px 0;
  font-size: 13px;
  color: #e5e7eb;
  line-height: 1.4;
}

.activity-input {
  width: 100%;
  background: rgba(31, 41, 55, 0.8);
  border: 1px solid rgba(139, 92, 246, 0.4);
  border-radius: 6px;
  padding: 10px 12px;
  color: #e5e7eb;
  font-size: 13px;
  font-family: 'Nunito', sans-serif;
  margin: 8px 0;
  transition: border-color 0.3s ease;
}

.activity-input:focus {
  outline: none;
  border-color: rgba(139, 92, 246, 0.8);
  box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
}

.activity-button {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 8px 4px 4px 0;
}

.activity-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.activity-toggle {
  background: transparent;
  border: 1px solid rgba(139, 92, 246, 0.4);
  color: #c084fc;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: auto;
}

.activity-toggle:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: rgba(139, 92, 246, 0.6);
}

/* Data tag styling to match theme */
.data-tag {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: 2px solid rgba(139, 92, 246, 0.4);
  color: white;
  font-family: 'Nunito', sans-serif;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
  transition: all 0.3s ease;
}

.data-tag:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.6);
  border: 2px solid rgba(139, 92, 246, 0.8);
}

/* Prerequisite button styling */
.prereq-button {
  background: linear-gradient(135deg, #8b5cf6, #3b82f6);
  border: 2px solid rgba(139, 92, 246, 0.4);
  padding: 12px 24px;
  border-radius: 25px;
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
  position: relative;
  overflow: hidden;
  font-family: 'Nunito', sans-serif;
}

.prereq-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.6);
  border: 2px solid rgba(139, 92, 246, 0.8);
}

.prereq-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.prereq-button:hover::before {
  left: 100%;
}

@media (max-width: 768px) {
  .city-card {
    padding: 16px;
    margin: 12px 0;
  }
  
  .pitstops-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .pitstop-item {
    padding: 16px;
  }
  
  .route-line {
    height: 40px;
  }
  
  .route-button {
    font-size: 18px;
    padding: 8px;
  }
}
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900">
  <div class="container mx-auto px-8 py-16">

    {% if page.lxdData.Prequisites %}
    <div class="mb-16 text-center">
      <h3 class="text-2xl font-bold text-white mb-8 cute-heading">üéØ Prerequisites</h3>
      <ul class="flex flex-wrap gap-8 justify-center">
        {% for prereq in page.lxdData.Prequisites %}
          <li>
            <a href="{{ site.baseurl}}{{ prereq.link }}" class="prereq-button cute-text">
              {{ prereq.title }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="relative z-10">
      
      <!-- Node Title & Description -->
      <div class="text-center mb-20">
        <div class="inline-block relative mb-10">
          <h2 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 cute-title">
            {{ page.lxdData.Title }}
          </h2>
          <div class="absolute -inset-2 bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 opacity-20 blur-xl rounded-lg"></div>
        </div>
        {% if page.lxdData.Description %}
        <p class="text-xl text-gray-300 max-w-4xl mx-auto leading-relaxed cute-text px-6">
          {{ page.lxdData.Description }}
        </p>
        {% endif %}
      </div>

      <!-- Debug info -->
      <div class="text-center mb-8 text-yellow-400 cute-text">
        <p>Debug: Cities found: {% if page.lxdData.Cities %}{{ page.lxdData.Cities.size }}{% else %}0{% endif %}</p>
      </div>

      <!-- Travel Route with Cities and Pitstops -->
      <div class="max-w-5xl mx-auto">
        {% if page.lxdData.Cities %}
          {% for city in page.lxdData.Cities %}
            
            <!-- City Card -->
            <div class="city-card rounded-2xl shadow-lg">
              <!-- City Title -->
              <div class="w-full mb-4">
                <h3 class="text-3xl xl:text-4xl font-bold text-white cute-heading">
                  üèôÔ∏è {{ city.Name }}
                </h3>
              </div>

              <!-- City Description -->
              <div class="w-full">
                {% if city.Description %}
                <p class="text-gray-300 text-lg leading-relaxed cute-text mb-4">{{ city.Description }}</p>
                {% endif %}
                {% if city.Challenge %}
                <div class="text-sm text-purple-400 cute-text mb-2">
                  üéØ <strong>Challenge:</strong> {{ city.Challenge }}
                </div>
                {% endif %}
                {% if city.Analogy %}
                <div class="text-sm text-blue-400 cute-text">
                  üí° <strong>Analogy:</strong> {{ city.Analogy }}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Travel Route & Pitstops (only if not the last city) -->
            {% unless forloop.last %}
              <div class="travel-route">
                <div class="route-line">
                  <!-- ENHANCED: Clickable route button -->
                  <button class="route-button" data-route="{{ forloop.index0 }}" title="Click to explore pitstops">
                    üõ£Ô∏è
                  </button>
                </div>
              </div>

              <!-- ENHANCED: Hidden pitstops section with activities -->
              {% if city.Pitstops and city.Pitstops.size > 0 %}
              <div class="pitstops-section" id="pitstops-{{ forloop.index0 }}">
                <div class="pitstops-title cute-subheading">
                  üó∫Ô∏è Travel Pitstops: {{ city.Name }} ‚Üí 
                  {% assign next_index = forloop.index %}
                  {% for next_city in page.lxdData.Cities %}
                    {% if forloop.index == next_index %}
                      {{ next_city.Name }}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                </div>
                
                <div class="pitstops-grid">
                  {% for pitstop in city.Pitstops %}
                    <div class="pitstop-item">
                      <div class="pitstop-name">
                        üìç {{ pitstop.Name }}
                      </div>
                      <div class="pitstop-description">
                        {{ pitstop.Description }}
                      </div>
                      
                      <!-- DYNAMIC ACTIVITY SECTION -->
                      <div class="pitstop-activity">
                        <div class="activity-title">
                          üéØ JavaScript Challenge
                          <button class="activity-toggle" onclick="toggleActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                            Try It
                          </button>
                        </div>
                        
                        <div class="activity-content" id="activity-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}">
                          <div class="activity-prompt" id="prompt-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                               data-original-activity="{{ pitstop.Activity | escape }}"
                               data-hints="{{ pitstop.Hints | join: '||' | escape }}">
                            <!-- Dynamic prompt will be generated by JavaScript -->
                          </div>
                          
                          <textarea 
                            class="activity-input" 
                            id="input-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                            placeholder="Type your JavaScript solution here..."
                            rows="4">
                          </textarea>
                          
                          <div>
                            <button class="activity-button" onclick="checkActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Submit
                            </button>
                            <button class="activity-button" onclick="hintActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Hint
                            </button>
                            <button class="activity-button" onclick="resetActivity('{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}')">
                              Reset
                            </button>
                          </div>
                          
                          <div class="activity-prompt" id="feedback-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}" style="display: none;">
                            <!-- Dynamic feedback will appear here -->
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            {% endunless %}

          {% endfor %}
        {% else %}
          <div class="text-center text-red-400">
            <p>No cities data found. Check your markdown file structure.</p>
          </div>
        {% endif %}
      </div>

      <!-- Back to Hub Button -->
      <div class="text-center mt-20">
        <a href="{{ site.baseurl }}/travel_hub" class="prereq-button cute-text inline-block">
          üè† Back to Travel Hub
        </a>
      </div>

    </div>
  </div>
</div>

<script type="text/javascript">
// Enhanced map visualization - ADD THIS AT THE TOP OF THE SCRIPT SECTION
function createFoodRouteMap() {
  const mapContainer = document.createElement('div');
  mapContainer.className = 'food-route-map mb-8';
  mapContainer.innerHTML = `
    <div class="relative bg-gradient-to-b from-blue-200 to-green-200 rounded-2xl p-8 mx-auto max-w-4xl">
      <!-- Map SVG with route line -->
      <svg viewBox="0 0 400 600" class="w-full h-64">
        <!-- Coast line -->
        <path d="M50 50 Q 60 150 40 250 Q 30 350 50 450 Q 70 550 60 600" 
              stroke="#2563eb" stroke-width="3" fill="none" class="coast-line"/>
        
        <!-- Route line connecting cities -->
        <path d="M80 480 L 120 360 L 160 240 L 200 120" 
              stroke="#8b5cf6" stroke-width="4" fill="none" 
              stroke-dasharray="10,5" class="route-line"/>
        
        <!-- City markers -->
        <g class="city-marker" data-city="san_diego">
          <circle cx="80" cy="480" r="20" fill="#fbbf24" stroke="#f59e0b" stroke-width="3"/>
          <text x="80" y="510" text-anchor="middle" class="text-sm font-bold" fill="white">San Diego</text>
          <text x="80" y="485" text-anchor="middle" class="text-xl">‚òÄÔ∏è</text>
        </g>
        
        <g class="city-marker" data-city="los_angeles">
          <circle cx="120" cy="360" r="20" fill="#a78bfa" stroke="#8b5cf6" stroke-width="3"/>
          <text x="120" y="390" text-anchor="middle" class="text-sm font-bold" fill="white">Los Angeles</text>
          <text x="120" y="365" text-anchor="middle" class="text-xl">üå¥</text>
        </g>
        
        <g class="city-marker" data-city="san_francisco">
          <circle cx="160" cy="240" r="20" fill="#60a5fa" stroke="#3b82f6" stroke-width="3"/>
          <text x="160" y="270" text-anchor="middle" class="text-sm font-bold" fill="white">San Francisco</text>
          <text x="160" y="245" text-anchor="middle" class="text-xl">üåÅ</text>
        </g>
        
        <g class="city-marker" data-city="seattle">
          <circle cx="200" cy="120" r="20" fill="#34d399" stroke="#10b981" stroke-width="3"/>
          <text x="200" y="150" text-anchor="middle" class="text-sm font-bold" fill="white">Seattle</text>
          <text x="200" y="125" text-anchor="middle" class="text-xl">üå≤</text>
        </g>
      </svg>
      
      <!-- Progress indicators -->
      <div class="mt-6 flex justify-between items-center">
        <div class="text-center">
          <div class="text-2xl font-bold text-purple-600" id="total-xp">0 XP</div>
          <div class="text-sm text-gray-600">Experience Points</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600" id="current-city">San Diego</div>
          <div class="text-sm text-gray-600">Current Location</div>
        </div>
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600" id="badges-earned">0/4</div>
          <div class="text-sm text-gray-600">Badges Earned</div>
        </div>
      </div>
    </div>
  `;
  
  return mapContainer;
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('=== ROUTE DROPDOWN SETUP ===');
  
  // Insert map before cities - ADD THIS TO YOUR EXISTING DOMContentLoaded
  const container = document.querySelector('.max-w-5xl.mx-auto');
  if (container) {
    const mapElement = createFoodRouteMap();
    container.insertBefore(mapElement, container.firstChild);
  }
  
  var routeButtons = document.querySelectorAll('.route-button');
  console.log('Found ' + routeButtons.length + ' route buttons');
  
  for (var i = 0; i < routeButtons.length; i++) {
    routeButtons[i].addEventListener('click', function(e) {
      console.log('Route button clicked!');
      
      var routeIndex = this.getAttribute('data-route');
      var pitstopsSection = document.getElementById('pitstops-' + routeIndex);
      
      console.log('Toggling pitstops-' + routeIndex);
      
      if (!pitstopsSection) {
        console.log('Pitstops section not found!');
        return;
      }
      
      var isVisible = pitstopsSection.classList.contains('show');
      console.log('Currently visible:', isVisible);
      
      // Close all other pitstops sections and reset buttons
      var allPitstops = document.querySelectorAll('.pitstops-section');
      var allButtons = document.querySelectorAll('.route-button');
      
      for (var j = 0; j < allPitstops.length; j++) {
        allPitstops[j].classList.remove('show');
      }
      
      for (var k = 0; k < allButtons.length; k++) {
        allButtons[k].classList.remove('active');
      }
      
      // Toggle current pitstops section
      if (!isVisible) {
        pitstopsSection.classList.add('show');
        this.classList.add('active');
        console.log('OPENED pitstops ' + routeIndex);
        
        // Smooth scroll to the pitstops section
        setTimeout(function() {
          pitstopsSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }, 200);
      } else {
        console.log('CLOSED pitstops ' + routeIndex);
      }
    });
  }
  
  // Initialize JavaScript activities
  initializeJavaScriptActivities();
});

function initializeJavaScriptActivities() {
  console.log('Initializing JavaScript activities...');
  
  var activityPrompts = document.querySelectorAll('[data-original-activity]');
  
  for (var i = 0; i < activityPrompts.length; i++) {
    var prompt = activityPrompts[i];
    var originalActivity = prompt.getAttribute('data-original-activity');
    var jsActivity = convertToJavaScript(originalActivity);
    prompt.textContent = jsActivity;
    console.log('Converted activity:', jsActivity);
  }
}

function convertToJavaScript(originalActivity) {
  if (!originalActivity) {
    return 'Write JavaScript code to practice programming concepts.';
  }
  
  var activity = originalActivity.toLowerCase();
  
  // Database table creation -> JavaScript object/class
  if (activity.includes('create') && activity.includes('table')) {
    if (activity.includes('taco')) {
      return 'Create a JavaScript class called FishTaco with properties: id, fishType, toppings (array), sauce, price, spiceLevel. Add a method to calculate total price with tax.';
    }
    if (activity.includes('burrito')) {
      return 'Design a JavaScript object structure for a burrito customization system. Create classes: Burrito, Ingredient. Add methods to addIngredient(), removeIngredient(), and calculatePrice().';
    }
    if (activity.includes('sauce')) {
      return 'Create a JavaScript Map to store sauce data with heat levels. Write functions: getSauceByName(), addNewSauce(), and filterSaucesByHeat(level).';
    }
  }
  
  // INSERT operations -> Object creation and validation
  if (activity.includes('insert')) {
    if (activity.includes('ceviche')) {
      return 'Write a JavaScript function validateCeviche(recipe) that checks: fish is "fresh", citrusTime is between 10-60 minutes, temperature is "cold". Return validation results.';
    }
    if (activity.includes('bbq') || activity.includes('transaction')) {
      return 'Create an async function orderBBQCombo() that simulates ordering multiple items. Use Promise.all() to handle multiple async operations and proper error handling.';
    }
  }
  
  // API design -> Fetch and REST
  if (activity.includes('api') || activity.includes('endpoint')) {
    if (activity.includes('taco')) {
      return 'Write a JavaScript function getTacos(filling, spice) that builds a query URL and uses fetch() to get taco data. Include error handling and response parsing.';
    }
    if (activity.includes('food truck')) {
      return 'Design JavaScript functions for a food truck API: getMenu(), createOrder(items), getOrderStatus(id). Use async/await and include proper error handling.';
    }
  }
  
  // Validation and security -> Input sanitization
  if (activity.includes('validation') || activity.includes('sanitiz')) {
    return 'Create a JavaScript function sanitizeUserInput(data) that validates and cleans user inputs. Handle special characters, length limits, and prevent XSS attacks.';
  }
  
  // Pagination -> Array methods and pagination logic
  if (activity.includes('pagination') || activity.includes('limit')) {
    return 'Write JavaScript pagination functions: getPage(data, pageNum, itemsPerPage), calculateTotalPages(totalItems, itemsPerPage). Include navigation logic.';
  }
  
  // Indexing/optimization -> Caching and performance
  if (activity.includes('index') || activity.includes('optimization')) {
    return 'Implement a JavaScript caching system using Map. Create functions: setCache(key, value, ttl), getCache(key), clearExpired(). Add performance timing with console.time().';
  }
  
  // JOIN operations -> Object merging and data combination
  if (activity.includes('join')) {
    return 'Write JavaScript functions to combine data from multiple arrays (dishes, ingredients, suppliers). Use array methods like map(), filter(), and reduce() to merge related data.';
  }
  
  // Backup/migration -> LocalStorage and data management
  if (activity.includes('backup') || activity.includes('migration')) {
    return 'Create JavaScript functions for data backup: saveToLocalStorage(data), restoreFromBackup(timestamp), listAvailableBackups(). Handle storage quota and data validation.';
  }
  
  // Monitoring/logging -> Performance tracking
  if (activity.includes('logging') || activity.includes('monitoring')) {
    return 'Build a JavaScript performance monitoring system. Track function execution times, API call durations, and user interactions. Store metrics and display simple analytics.';
  }
  
  // Generic conversion
  return 'JavaScript Challenge: ' + originalActivity.replace(/SQL|CREATE TABLE|INSERT|SELECT|UPDATE|DELETE/gi, function(match) {
    var replacements = {
      'SQL': 'JavaScript',
      'CREATE TABLE': 'Create a JavaScript class',
      'INSERT': 'Add data using JavaScript',
      'SELECT': 'Filter data using JavaScript',
      'UPDATE': 'Modify data using JavaScript',
      'DELETE': 'Remove data using JavaScript'
    };
    return replacements[match.toUpperCase()] || match;
  });
}

function toggleActivity(activityId) {
  var content = document.getElementById('activity-' + activityId);
  var toggle = event.target;
  
  if (!content) {
    console.error('Activity content not found for:', activityId);
    return;
  }
  
  if (content.classList.contains('show')) {
    content.classList.remove('show');
    toggle.textContent = 'Try It';
  } else {
    content.classList.add('show');
    toggle.textContent = 'Hide';
  }
}

function checkActivity(activityId) {
  var input = document.getElementById('input-' + activityId);
  var feedback = document.getElementById('feedback-' + activityId);
  
  if (!input || !feedback) {
    console.error('Input or feedback element not found for:', activityId);
    return;
  }
  
  var userInput = input.value.trim();
  
  if (userInput.length < 15) {
    showFeedback(feedback, "Try to provide a more detailed JavaScript solution! Add more code and explanation.", "warning");
    return;
  }
  
  // Check for JavaScript-specific terms
  var jsTerms = ['function', 'const', 'let', 'var', 'class', 'async', 'await', 'fetch', 'map', 'filter', 'reduce', '=>', 'return'];
  var hasJSTerms = jsTerms.some(function(term) {
    return userInput.toLowerCase().includes(term);
  });
  
  if (hasJSTerms) {
    var hasGoodPractices = userInput.includes('//') || userInput.includes('const') || userInput.includes('let') || userInput.includes('try');
    
    if (hasGoodPractices) {
      showFeedback(feedback, "Excellent JavaScript! Great use of modern syntax and best practices! üöÄ", "success");
      // SAVE PROGRESS - Mark activity as completed
      saveActivityProgress(activityId, true);
    } else {
      showFeedback(feedback, "Good JavaScript! Try adding comments and using const/let for better practices. ‚ú®", "info");
      // SAVE PARTIAL PROGRESS
      saveActivityProgress(activityId, false);
    }
  } else {
    showFeedback(feedback, "Good start! Try including JavaScript syntax like functions, variables (const/let), or array methods. üìù", "info");
  }
}

// NEW: Progress saving functions
function saveActivityProgress(activityId, isCompleted) {
  // Get current theme from URL
  var currentTheme = getCurrentTheme();
  
  if (!currentTheme) {
    console.error('Could not determine current theme');
    return;
  }
  
  // Load existing progress
  var progress = loadProgress();
  
  // Create unique activity identifier
  var fullActivityId = currentTheme + '_' + activityId;
  
  if (isCompleted) {
    // Mark as completed if not already
    if (!progress.themes[currentTheme].completedActivities.includes(fullActivityId)) {
      progress.themes[currentTheme].completedActivities.push(fullActivityId);
      progress.globalStats.totalActivitiesCompleted++;
      progress.globalStats.tokensEarned += 10;
      
      // Update theme progress
      progress.themes[currentTheme].totalProgress = calculateThemeProgress(progress.themes[currentTheme]);
      
      // Check if we completed a new city (every 3 activities)
      var activitiesCount = progress.themes[currentTheme].completedActivities.length;
      var newCitiesVisited = Math.floor(activitiesCount / 3);
      var oldCitiesVisited = Math.floor((activitiesCount - 1) / 3);
      
      if (newCitiesVisited > oldCitiesVisited) {
        progress.globalStats.citiesVisited++;
        showCityCompletionFeedback(currentTheme, newCitiesVisited);
      }
      
      saveProgress(progress);
      showActivityCompletionFeedback(fullActivityId);
    }
  } else {
    // Save partial progress (attempt made)
    if (!progress.themes[currentTheme].attemptedActivities) {
      progress.themes[currentTheme].attemptedActivities = [];
    }
    if (!progress.themes[currentTheme].attemptedActivities.includes(fullActivityId)) {
      progress.themes[currentTheme].attemptedActivities.push(fullActivityId);
      progress.globalStats.tokensEarned += 2; // Smaller reward for attempts
      saveProgress(progress);
    }
  }
}

function getCurrentTheme() {
  // Try to get theme from URL
  var urlPath = window.location.pathname;
  var urlMatch = urlPath.match(/\/node\/(\w+)/);
  if (urlMatch) {
    return urlMatch[1];
  }
  
  // Try to get from page title or other indicators
  var title = document.title.toLowerCase();
  if (title.includes('ai')) return 'ai';
  if (title.includes('sports')) return 'sports';
  if (title.includes('food')) return 'food';
  if (title.includes('travel')) return 'travel';
  
  // Fallback - try to detect from page content
  var heading = document.querySelector('h2');
  if (heading) {
    var headingText = heading.textContent.toLowerCase();
    if (headingText.includes('ai')) return 'ai';
    if (headingText.includes('sports')) return 'sports';
    if (headingText.includes('food')) return 'food';
    if (headingText.includes('travel')) return 'travel';
  }
  
  return null;
}

function loadProgress() {
  const PROGRESS_KEY = 'mchopiee_travel_progress';
  var saved = localStorage.getItem(PROGRESS_KEY);
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (e) {
      console.error('Error loading progress:', e);
    }
  }
  
  // Default progress structure
  return {
    themes: {
      ai: { completedActivities: [], attemptedActivities: [], totalProgress: 0 },
      sports: { completedActivities: [], attemptedActivities: [], totalProgress: 0 },
      food: { completedActivities: [], attemptedActivities: [], totalProgress: 0 },
      travel: { completedActivities: [], attemptedActivities: [], totalProgress: 0 }
    },
    globalStats: {
      totalActivitiesCompleted: 0,
      totalSegmentsCompleted: 0,
      citiesVisited: 0,
      tokensEarned: 0
    }
  };
}

function saveProgress(progressData) {
  const PROGRESS_KEY = 'mchopiee_travel_progress';
  try {
    localStorage.setItem(PROGRESS_KEY, JSON.stringify(progressData));
    console.log('Progress saved:', progressData);
  } catch (e) {
    console.error('Error saving progress:', e);
  }
}

function calculateThemeProgress(themeData) {
  // Each theme has 4 cities, estimate 3-4 activities per city
  var estimatedTotalActivities = 12; // 4 cities √ó 3 activities average
  var completedActivities = themeData.completedActivities.length;
  return Math.min(100, Math.round((completedActivities / estimatedTotalActivities) * 100));
}

function showActivityCompletionFeedback(activityId) {
  // Create a toast notification
  var toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
  toast.innerHTML = '<div class="flex items-center gap-2"><span class="text-lg">üéâ</span><div><div class="font-bold">Activity Completed!</div><div class="text-sm">+10 tokens earned</div></div></div>';
  
  document.body.appendChild(toast);
  
  // Animate in
  setTimeout(function() {
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  // Remove after 3 seconds
  setTimeout(function() {
    toast.style.transform = 'translateX(100%)';
    setTimeout(function() {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function showCityCompletionFeedback(theme, cityNumber) {
  var toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
  toast.innerHTML = '<div class="flex items-center gap-2"><span class="text-lg">üèôÔ∏è</span><div><div class="font-bold">City Completed!</div><div class="text-sm">City ' + cityNumber + ' in ' + theme.toUpperCase() + ' route!</div></div></div>';
  
  document.body.appendChild(toast);
  
  setTimeout(function() {
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  setTimeout(function() {
    toast.style.transform = 'translateX(100%)';
    setTimeout(function() {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 4000);
}

// Load and display existing progress when page loads
document.addEventListener('DOMContentLoaded', function() {
  // ... existing DOMContentLoaded code ...
  
  // Load progress and mark completed activities
  loadAndDisplayProgress();
});

function loadAndDisplayProgress() {
  var progress = loadProgress();
  var currentTheme = getCurrentTheme();
  
  if (!currentTheme) return;
  
  var themeData = progress.themes[currentTheme];
  if (!themeData) return;
  
  // Mark completed activities with visual indicators
  themeData.completedActivities.forEach(function(fullActivityId) {
    var activityId = fullActivityId.replace(currentTheme + '_', '');
    var activityElement = document.getElementById('activity-' + activityId);
    var inputElement = document.getElementById('input-' + activityId);
    var feedbackElement = document.getElementById('feedback-' + activityId);
    
    if (activityElement) {
      // Add completed styling
      activityElement.style.border = '2px solid #10b981';
      activityElement.style.background = 'rgba(16, 185, 129, 0.1)';
      
      if (feedbackElement) {
        showFeedback(feedbackElement, "‚úÖ Previously completed! Great work!", "success");
      }
      
      if (inputElement) {
        inputElement.style.background = 'rgba(16, 185, 129, 0.1)';
      }
    }
  });
  
  // Mark attempted activities
  if (themeData.attemptedActivities) {
    themeData.attemptedActivities.forEach(function(fullActivityId) {
      var activityId = fullActivityId.replace(currentTheme + '_', '');
      var activityElement = document.getElementById('activity-' + activityId);
      
      if (activityElement && !themeData.completedActivities.includes(fullActivityId)) {
        // Add attempted styling
        activityElement.style.border = '2px solid #f59e0b';
        activityElement.style.background = 'rgba(245, 158, 11, 0.1)';
      }
    });
  }
}

function showFeedback(feedbackElement, message, type) {
  if (!feedbackElement) {
    console.error('Feedback element not found');
    return;
  }
  
  // Clear any existing classes
  feedbackElement.className = 'activity-prompt';
  
  // Add type-specific styling
  if (type === 'success') {
    feedbackElement.style.borderLeftColor = '#10b981';
    feedbackElement.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
    feedbackElement.style.color = '#34d399';
  } else if (type === 'warning') {
    feedbackElement.style.borderLeftColor = '#f59e0b';
    feedbackElement.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
    feedbackElement.style.color = '#fbbf24';
  } else if (type === 'info') {
    feedbackElement.style.borderLeftColor = '#3b82f6';
    feedbackElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
    feedbackElement.style.color = '#60a5fa';
  } else {
    feedbackElement.style.borderLeftColor = '#8b5cf6';
    feedbackElement.style.backgroundColor = 'rgba(139, 92, 246, 0.1)';
    feedbackElement.style.color = '#c084fc';
  }
  
  feedbackElement.textContent = message;
  feedbackElement.style.display = 'block';
  
  // Animate in
  feedbackElement.style.opacity = '0';
  feedbackElement.style.transform = 'translateY(-10px)';
  
  setTimeout(function() {
    feedbackElement.style.transition = 'all 0.3s ease';
    feedbackElement.style.opacity = '1';
    feedbackElement.style.transform = 'translateY(0)';
  }, 50);
}

function hintActivity(activityId) {
  var promptElement = document.getElementById('prompt-' + activityId);
  var feedbackElement = document.getElementById('feedback-' + activityId);
  
  if (!promptElement || !feedbackElement) {
    console.error('Prompt or feedback element not found for:', activityId);
    return;
  }
  
  var hints = promptElement.getAttribute('data-hints');
  if (hints) {
    var hintArray = hints.split('||');
    var randomHint = hintArray[Math.floor(Math.random() * hintArray.length)];
    showFeedback(feedbackElement, "üí° Hint: " + randomHint, "info");
  } else {
    showFeedback(feedbackElement, "üí° Hint: Try using modern JavaScript features like const/let, arrow functions, or array methods like map(), filter(), reduce().", "info");
  }
}

function resetActivity(activityId) {
  var inputElement = document.getElementById('input-' + activityId);
  var feedbackElement = document.getElementById('feedback-' + activityId);
  var activityElement = document.getElementById('activity-' + activityId);
  
  if (inputElement) {
    inputElement.value = '';
    inputElement.style.background = 'rgba(31, 41, 55, 0.8)';
  }
  
  if (feedbackElement) {
    feedbackElement.style.display = 'none';
    feedbackElement.textContent = '';
  }
  
  if (activityElement) {
    activityElement.style.border = '1px solid rgba(139, 92, 246, 0.3)';
    activityElement.style.background = 'rgba(139, 92, 246, 0.1)';
  }
  
  showFeedback(feedbackElement, "üîÑ Activity reset! Try again with a fresh start.", "info");
}

// Enhanced progress structure for Food Module
function createFoodModuleProgress() {
  return {
    currentCity: 'san_diego',
    xp: 0,
    badges: [],
    dishes: [],
    cities: {
      san_diego: {
        unlocked: true,
        completed: false,
        tasks: {
          'create_baja_bowl': { completed: false, xp: 50 },
          'add_ingredients': { completed: false, xp: 30 },
          'photo_upload': { completed: false, xp: 20 }
        }
      },
      los_angeles: {
        unlocked: false,
        completed: false,
        tasks: {
          'filter_trucks': { completed: false, xp: 40 },
          'search_dishes': { completed: false, xp: 30 },
          'performance_test': { completed: false, xp: 30 }
        }
      },
      san_francisco: {
        unlocked: false,
        completed: false,
        tasks: {
          'edit_menu': { completed: false, xp: 60 },
          'handle_conflicts': { completed: false, xp: 40 },
          'transaction_demo': { completed: false, xp: 50 }
        }
      },
      seattle: {
        unlocked: false,
        completed: false,
        tasks: {
          'soft_delete': { completed: false, xp: 40 },
          'analytics_dashboard': { completed: false, xp: 60 },
          'cleanup_master': { completed: false, xp: 30 }
        }
      }
    }
  };
}

// Enhanced activity validation for different city types
function validateFoodActivity(cityName, taskName, userCode) {
  const validators = {
    san_diego: {
      create_baja_bowl: (code) => {
        return code.includes('class') && code.includes('constructor') && 
               code.includes('ingredients') && code.includes('calories');
      },
      add_ingredients: (code) => {
        return code.includes('push') || code.includes('add') && 
               code.includes('array') || code.includes('ingredients');
      }
    },
    los_angeles: {
      filter_trucks: (code) => {
        return code.includes('filter') && (code.includes('includes') || code.includes('indexOf'));
      },
      search_dishes: (code) => {
        return code.includes('search') && code.includes('toLowerCase');
      }
    },
    san_francisco: {
      edit_menu: (code) => {
        return code.includes('update') || code.includes('modify') && 
               code.includes('transaction') || code.includes('try');
      },
      handle_conflicts: (code) => {
        return code.includes('version') || code.includes('conflict') && 
               code.includes('merge') || code.includes('resolve');
      }
    },
    seattle: {
      soft_delete: (code) => {
        return code.includes('deleted_at') || code.includes('archived') && 
               code.includes('Date') || code.includes('timestamp');
      },
      analytics_dashboard: (code) => {
        return code.includes('reduce') || code.includes('group') && 
               code.includes('count') || code.includes('sum');
      }
    }
  };
  
  const cityValidators = validators[cityName];
  if (!cityValidators || !cityValidators[taskName]) {
    return { valid: false, message: "Unknown task" };
  }
  
  const isValid = cityValidators[taskName](userCode.toLowerCase());
  return {
    valid: isValid,
    message: isValid ? "Great work!" : "Try including the required concepts for this task"
  };
}
</script>